# REST API Plan

## 1. Resources

- **Users (auth.users)**: 
  - Represents user accounts managed by Supabase Auth. Contains email, name, registration date, encrypted password, and confirmed_at.

- **Flashcards**:
  - Maps to the `flashcards` table in the database.
  - Key fields include:
    - `uuid` (primary key)
    - `user_id` (foreign key referencing auth.users)
    - `przód` (front text, VARCHAR(200))
    - `tył` (back text, VARCHAR(500))
    - `created_at` (timestamp)
    - `metoda_tworzna` (ENUM: "AI", "manual")
    - `status_recenzji` (ENUM: "pending", "accepted", "rejected")

- **Generations**:
  - Maps to the `generations` table.
  - Logs operations for flashcard generation with fields:
    - `uuid` (primary key)
    - `user_id` (foreign key)
    - `created_at` (timestamp)
    - `status` (VARCHAR(50))

- **Generations Error Logs**:
  - Maps to the `generations_error_log` table.
  - Captures error information for generation operations with fields:
    - `uuid` (primary key)
    - `user_id` (foreign key)
    - `created_at` (timestamp)
    - `error_message` (TEXT, no size limit)

## 2. Endpoints

### 2.2 Flashcards

- **GET /flashcards**
  - **Description:** Retrieve a paginated list of flashcards belonging to the authenticated user.
  - **Query Parameters:**
    - `page`: Page number
    - `limit`: Items per page
    - `sort`: Sort order (e.g., by `created_at`)
    - Optional filters (e.g., by review status)
  - **Response:** JSON array of flashcard objects.
  - **Errors:** 401 for unauthorized access.

- **GET /flashcards/{id}**
  - **Description:** Retrieve details for a specific flashcard using its UUID.
  - **Response:** Flashcard object with all details.
  - **Errors:** 404 if flashcard not found; 401 for unauthorized access.

- **POST /flashcards**
  - **Description:** Create new flashcard(s) either manually or as generated by AI. This endpoint supports bulk creation by accepting either a single flashcard object or an array of flashcard objects.
  - **Request Payload:** Can be either:
    - A single object:
    ```json
    { "front": "string (max 200 characters)", "back": "string (max 500 characters)", "metoda_tworzna": "manual" or "AI" }
    ```
    - Or an array of objects:
    ```json
    [ { "front": "string (max 200 characters)", "back": "string (max 500 characters)", "metoda_tworzna": "manual" or "AI" }, ... ]
    ```
  - **Response:** The created flashcard(s) including their UUIDs and default review status ("pending"). For AI-generated flashcards, the status remains "pending" until they are reviewed.
  - **Errors:** 400 for validation errors; 401 for unauthorized access.

- **PUT /flashcards/{id}**
  - **Description:** Update an existing flashcard.
  - **Request Payload:**
    ```json
    { "front": "string (max 200 characters)", "back": "string (max 500 characters)" }
    ```
  - **Response:** Updated flashcard object.
  - **Errors:** 400 for validation errors; 404 if not found; 401 for unauthorized access.

- **DELETE /flashcards/{id}**
  - **Description:** Delete a specific flashcard.
  - **Response:** Success confirmation message.
  - **Errors:** 404 if flashcard not found; 401 for unauthorized access.

- **POST /flashcards/generate**
  - **Description:** Initiate AI-based flashcard generation using user-provided input ("wkład").
  - **Request Payload:**
    ```json
    { "input": "string (max 10000 characters)" }
    ```
  - **Response:** Generation request details including a generation ID and current status.
  - **Errors:** 400 if input validation fails; 401 for unauthorized access.

- **GET /flashcards/review**
  - **Description:** Retrieve flashcards that are pending review (i.e., review status is "pending").
  - **Query Parameters:** Pagination and optional filtering criteria.
  - **Response:** List of flashcards requiring review.
  - **Errors:** 401 for unauthorized access.

- **POST /flashcards/{id}/review**
  - **Description:** Review a flashcard by accepting, rejecting, or editing it.
  - **Request Payload:**
    ```json
    { "action": "accept" | "reject" | "edit", "front": "string (optional)", "back": "string (optional)" }
    ```
    - For "accept": The flashcard's review status is updated to "accepted".
    - For "reject": The flashcard's review status is updated to "rejected".
    - For "edit": The flashcard is updated with the provided content and marked as "accepted".
  - **Response:** Updated flashcard object.
  - **Errors:** 400 for invalid action or validation errors; 404 if flashcard not found; 401 for unauthorized access.

### 2.3 Generations

- **GET /generations**
  - **Description:** Retrieve a list of flashcard generation operations for the authenticated user.
  - **Query Parameters:**
    - `page`, `limit`, `sort`
  - **Response:** JSON array of generation records.
  - **Errors:** 401 for unauthorized access.

- **GET /generations/{id}**
  - **Description:** Retrieve detailed information about a specific generation operation using its UUID.
  - **Response:** Generation object with status and timestamps.
  - **Errors:** 404 if not found; 401 for unauthorized access.

### 2.4 Generations Error Logs

- **GET /generations-error-logs**
  - **Description:** Retrieve a list of error logs associated with flashcard generation operations.
  - **Query Parameters:** Pagination and optional filtering (e.g., by timestamp or generation ID).
  - **Response:** JSON array of error log records.
  - **Errors:** 401 for unauthorized access.

## 3. Authentication and Authorization

- **Mechanism:** JWT-based authentication (supplied via Supabase Auth).
- **Header:** Include the JWT in the `Authorization` header formatted as `Bearer <token>`.
- **Access Control:** 
  - Enforced at the API layer and through Row Level Security (RLS) on the database side.
  - Users can only access resources associated with their own user ID.
- **Additional Security:** Implementation of rate limiting, input sanitization, and proper error responses to prevent abuse.

## 4. Validation and Business Logic

- **Flashcards Validation:**
  - The `front` field must not exceed 200 characters.
  - The `back` field must not exceed 500 characters.
  - The `metoda_tworzna` is set to "manual" for manually created flashcards.
  - The `status_recenzji` starts as "pending" and can only transition to "accepted" or "rejected" via the review endpoint.

- **AI Flashcard Generation:**
  - Input ("wkład") is validated to ensure it does not exceed 10,000 characters.
  - A generation operation is logged in the `generations` table upon initiation.
  - Errors during generation are recorded in the `generations_error_log` table.

- **Business Logic Mapping:**
  - Standard CRUD operations handle manual flashcard creation and editing.
  - Dedicated endpoints manage the AI generation process and subsequent review actions, ensuring state transitions and validations align with product requirements.

- **Error Handling:**
  - HTTP 400 for bad requests and validation errors.
  - HTTP 401 for unauthorized access.
  - HTTP 404 for resources that are not found.
  - HTTP 500 for internal server errors.

## 5. Additional Considerations

- **Pagination, Sorting, and Filtering:**
  - All list endpoints support `page` and `limit` query parameters, along with optional sorting and filtering to optimize data retrieval.

- **Performance:**
  - Database indexes (e.g., on `user_id` and `created_at`) are leveraged to ensure efficient data queries.

- **Security Measures:**
  - Rate limiting is applied to sensitive endpoints such as flashcard generation.
  - Input validation and sanitization are enforced on all endpoints.

- **Assumptions:**
  - User authentication and session management are primarily managed via Supabase Auth, thereby reducing the need for custom authentication logic within the API itself.
  - Row Level Security (RLS) in the database adds an extra layer of data access control, complementing the API-level authorization mechanisms. 